name: Deploy WEB (CobranzaDigital)

on:
  push:
    branches: [ "main" ]
    paths:
      - "frontend/**"
      - ".github/workflows/deploy-web.yml"

permissions:
  contents: read

concurrency:
  group: deploy-web-main
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      CD_SSH_HOST: ${{ secrets.CD_SSH_HOST }}
      CD_SSH_PORT: ${{ secrets.CD_SSH_PORT }}
      CD_USER: ${{ secrets.CD_USER }}
      CD_WEB_PATH: ${{ secrets.CD_WEB_PATH }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Install deps
        working-directory: frontend
        run: npm ci

      - name: Build (production)
        working-directory: frontend
        run: npm run build -- --configuration production

      - name: Detect build output (folder that contains index.html)
        shell: bash
        run: |
          set -euo pipefail

          # Caso SSR (dist/<app>/browser)
          if [ -f "frontend/dist/cobranza-digital/browser/index.html" ]; then
            echo "Detected SSR output. Using: frontend/dist/cobranza-digital/browser"
            echo "DIST_DIR=frontend/dist/cobranza-digital/browser" >> $GITHUB_ENV
          # Caso SPA (dist/<app>)
          elif [ -f "frontend/dist/cobranza-digital/index.html" ]; then
            echo "Detected SPA output. Using: frontend/dist/cobranza-digital"
            echo "DIST_DIR=frontend/dist/cobranza-digital" >> $GITHUB_ENV
          else
            echo "ERROR: No pude encontrar index.html en frontend/dist"
            find frontend/dist -maxdepth 4 -type f -name index.html -print || true
            exit 1
          fi

      - name: Show dist output
        shell: bash
        run: |
          set -euo pipefail
          echo "DIST_DIR=$DIST_DIR"
          ls -la "$DIST_DIR"

      - name: Setup SSH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "${{ secrets.CD_SSH_KEY_B64 }}" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          ssh-keyscan -p "$CD_SSH_PORT" -H "$CD_SSH_HOST" >> ~/.ssh/known_hosts

      - name: Prepare remote folder (clean)
        shell: bash
        run: |
          set -euo pipefail
          ssh -i ~/.ssh/id_ed25519 -o IdentitiesOnly=yes -p "$CD_SSH_PORT" "$CD_USER@$CD_SSH_HOST" \
            "mkdir -p '$CD_WEB_PATH' && find '$CD_WEB_PATH' -mindepth 1 -maxdepth 1 -exec rm -rf {} +"

      - name: Deploy via rsync
        shell: bash
        run: |
          set -euo pipefail

          # -O = no tocar timestamps de directorios (arregla Operation not permitted)
          # --no-perms/--no-owner/--no-group para evitar attrs problem√°ticos
          rsync -az --delete -O --no-perms --no-owner --no-group \
            "$DIST_DIR"/ \
            -e "ssh -i ~/.ssh/id_ed25519 -o IdentitiesOnly=yes -p $CD_SSH_PORT" \
            "$CD_USER@$CD_SSH_HOST:$CD_WEB_PATH/"
