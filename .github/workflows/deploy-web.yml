name: Deploy Web (CobranzaDigital)

on:
  push:
    branches: [ "main" ]
    paths:
      - "frontend/**"
      - ".github/workflows/deploy-web.yml"
  workflow_dispatch:

concurrency:
  group: deploy-web-main
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Install deps
        working-directory: frontend
        run: npm ci

      - name: Build (production)
        working-directory: frontend
        run: npm run build -- --configuration production

      - name: Detect build output (folder that contains index.html)
        id: out
        working-directory: frontend
        shell: bash
        run: |
          set -euo pipefail
          INDEX="$(find dist -type f -name index.html | head -n 1)"
          if [ -z "$INDEX" ]; then
            echo "No se encontrÃ³ index.html dentro de frontend/dist"
            echo "Contenido de dist:"
            ls -la dist || true
            exit 1
          fi
          OUT_DIR="$(dirname "$INDEX")"
          echo "index=$INDEX"
          echo "out_dir=$OUT_DIR"
          echo "out_dir=$OUT_DIR" >> "$GITHUB_OUTPUT"

      - name: Setup SSH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s' "${{ secrets.CD_SSH_KEY_B64 }}" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -4 -T 10 -p "${{ secrets.CD_SSH_PORT }}" -H "${{ secrets.CD_SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Prepare remote folder (clean)
        shell: bash
        run: |
          set -euo pipefail
          ssh -p "${{ secrets.CD_SSH_PORT }}" deploy@"${{ secrets.CD_SSH_HOST }}" \
            "mkdir -p /var/www/cobranzadigital/web && rm -rf /var/www/cobranzadigital/web/*"

      - name: Deploy via rsync
        shell: bash
        run: |
          set -euo pipefail
          rsync -az --delete \
            -e "ssh -p ${{ secrets.CD_SSH_PORT }} -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes" \
            "${{ steps.out.outputs.out_dir }}/" \
            deploy@"${{ secrets.CD_SSH_HOST }}":/var/www/cobranzadigital/web/
