# Testing Matrix (Feature/Endpoint → Tests → Qué actualizar)

Base inicial derivada de `docs/Corte-Implementacion.md` para estandarizar mantenimiento de pruebas.

| Feature / Endpoint                                                                                | Tests existentes (base)                                                                                                                                                                      | Si se modifica, qué actualizar                                                                                                                                                                                    |
| ------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `POST /api/v1/pos/sales` (crear venta)                                                            | Integration backend de creación, reglas de pago/idempotencia y cálculo server-side (según corte).                                                                                            | Integration tests de contrato (request/response), reglas de `payment.reference`, idempotencia `clientSaleId`; Vitest si cambia mapping UI; E2E UI-contract POS si cambia flujo de venta/cobro.                    |
| `GET /api/v1/pos/reports/daily-summary`                                                           | Integration backend para agregado diario (según corte).                                                                                                                                      | Integration tests de filtros y shape de respuesta; E2E si afecta pantalla operativa/reportes visibles.                                                                                                            |
| `GET /api/v1/pos/reports/top-products`                                                            | Cobertura en servicio con verificación principal; pendiente robustecer empates/orden estable (según corte).                                                                                  | Integration/backend tests para orden estable y empates; actualizar docs de reporte si cambia contrato.                                                                                                            |
| `GET /api/v1/pos/reports/top-products` (filtros opcionales `storeId`, `cashierUserId`, `shiftId`) | `backend/tests/CobranzaDigital.Api.Tests/PosReportsIntegrationTests.cs` valida compat + filtros nuevos sin romper contrato previo.                                                           | Mantener pruebas de compatibilidad y filtros cuando evolucione el reporte.                                                                                                                                        |
| `GET /api/v1/pos/reports/sales/daily`                                                             | `backend/tests/CobranzaDigital.Api.Tests/PosReportsIntegrationTests.cs` valida tickets/totales/avgTicket, exclusión de voided y agrupación por fecha local.                                  | Mantener Integration tests con casos multi-día y verificar TZ (`Store.TimeZoneId`) + filtros por store.                                                                                                           |
| `GET /api/v1/pos/reports/payments/methods`                                                        | `backend/tests/CobranzaDigital.Api.Tests/PosReportsIntegrationTests.cs` valida suma por método excluyendo voided.                                                                            | Ajustar Integration tests al agregar métodos de pago o reglas de exclusión.                                                                                                                                       |
| `GET /api/v1/pos/reports/sales/hourly`                                                            | `backend/tests/CobranzaDigital.Api.Tests/PosReportsIntegrationTests.cs` valida buckets por hora local.                                                                                       | Actualizar pruebas de TZ y agrupación cuando cambie lógica de negocio/husos.                                                                                                                                      |
| `GET /api/v1/pos/reports/sales/cashiers`                                                          | `backend/tests/CobranzaDigital.Api.Tests/PosReportsIntegrationTests.cs` valida agregación por `CreatedByUserId` y voids por cajero.                                                          | Mantener pruebas de agregación y permisos (Admin/Manager vs Cashier).                                                                                                                                             |
| `GET /api/v1/pos/reports/shifts/summary`                                                          | `backend/tests/CobranzaDigital.Api.Tests/PosReportsIntegrationTests.cs` valida tickets, totales, pagos y `cashDifference` por turno.                                                         | Actualizar Integration tests al cambiar reglas de cierre/caja o filtros por cashier.                                                                                                                              |
| `GET /api/v1/pos/reports/voids/reasons`                                                           | `backend/tests/CobranzaDigital.Api.Tests/PosReportsIntegrationTests.cs` valida count/amount por razón y sólo ventas voided.                                                                  | Agregar casos si se incorporan nuevas razones o textos normalizados.                                                                                                                                              |
| `GET /api/v1/pos/reports/sales/categories`                                                        | `backend/tests/CobranzaDigital.Api.Tests/PosReportsV2IntegrationTests.cs` valida mix por categoría y `grossSales` incluyendo extras + selections.                                            | Mantener pruebas de TZ (`Store.TimeZoneId`), exclusión de voided y filtros `storeId/cashierUserId/shiftId`.                                                                                                       |
| `GET /api/v1/pos/reports/sales/products`                                                          | `backend/tests/CobranzaDigital.Api.Tests/PosReportsV2IntegrationTests.cs` valida top, snapshots (`sku/productName`) y `grossSales` con extras + selections.                                  | Actualizar pruebas al cambiar top/defaults, shape de respuesta o reglas de cálculo por línea.                                                                                                                     |
| `GET /api/v1/pos/reports/sales/addons/extras`                                                     | `backend/tests/CobranzaDigital.Api.Tests/PosReportsV2IntegrationTests.cs` valida acumulado de extras más vendidos (`quantity` y `grossSales`).                                               | Agregar casos de empate/orden y verificar exclusión de ventas voided.                                                                                                                                             |
| `GET /api/v1/pos/reports/sales/addons/options`                                                    | `backend/tests/CobranzaDigital.Api.Tests/PosReportsV2IntegrationTests.cs` valida `usageCount` ponderado por cantidad y `grossImpact` por `PriceDeltaSnapshot`.                               | Mantener pruebas de ponderación por `SaleItems.Quantity` y casos con `PriceDeltaSnapshot` cero/negativo.                                                                                                          |
| `GET /api/v1/pos/reports/kpis/summary`                                                            | `backend/tests/CobranzaDigital.Api.Tests/PosReportsV2IntegrationTests.cs` valida `tickets`, `totalItems`, `avgTicket`, `avgItemsPerTicket`, `voidRate`.                                      | Actualizar casos cuando cambie la definición de KPIs (denominador de void rate, redondeos, exclusiones).                                                                                                          |
| `GET /api/v1/pos/reports/control/cash-differences`                                                | `backend/tests/CobranzaDigital.Api.Tests/PosReportsV2IntegrationTests.cs` valida salida `daily` + `shifts`, diferencias, `cashierUserId` + `cashierUserName` y conteo de razones por cierre.     | Mantener pruebas de agrupación por fecha local, filtros por cashier/store y consistencia expected/counted/difference; validar fallback de UI a `cashierUserId` si falta `cashierUserName`.                      |
| Flujo de turnos POS (open / preview / close)                                                      | Cobertura parcial descrita en corte para reglas de caja/cierre.                                                                                                                              | Integration backend para reglas de cierre y diferencias; E2E Playwright para flujo crítico de caja si cambia UX o contrato UI↔API.                                                                                |
| Auditoría de acciones críticas (Admin/POS)                                                        | Convención y campos documentados en `docs/auditing.md`; cobertura parcial por módulo.                                                                                                        | Tests backend que verifiquen `Action`, `EntityType`, `EntityId`, `CorrelationId`; actualizar docs si se agregan nuevas acciones/convenciones.                                                                     |
| Contratos Admin (users/roles/lock)                                                                | Compatibilidades documentadas en `docs/compatibility-notes.md`.                                                                                                                              | Integration tests de compat (`page`/`pageNumber`, `POST`/`PUT` lock, DTO roles); actualizar compatibility notes si cambia fallback.                                                                               |
| Frontend mapping/validaciones de formularios críticos                                             | Suite Vitest del frontend (según CI vigente).                                                                                                                                                | Agregar/actualizar unit tests Vitest por cada cambio de mapping, validación o normalización de payload.                                                                                                           |
| Flujos críticos UI POS (venta/cobros/cierre/void)                                                 | E2E Playwright en CI (cuando aplica frontend).                                                                                                                                               | Agregar/actualizar E2E deterministas con `data-testid` e intercept de `/api/v1/pos/**` para validar contrato y resultado en UI.                                                                                   |
| POS Reports v1 UI (`/app/pos/reportes`)                                                           | Unit tests Vitest (`pos-reports-api.service.spec.ts`, `pos-reportes.page.spec.ts`) y E2E Playwright (`frontend/e2e/pos.reports.contract.spec.ts`) para contrato UI↔API.                      | Mantener unit tests de filtros/mapping y E2E determinista con intercept de `/api/v1/pos/**` al cambiar filtros, TZ o tablas del dashboard.                                                                        |
| POS Reports v2 UI (`/app/pos/reportes`)                                                           | Unit tests Vitest (`pos-reports-api.service.spec.ts`, `pos-reportes.page.spec.ts`) para endpoints v2 + errores por bloque y E2E Playwright (`frontend/e2e/pos.reports.v2.contract.spec.ts`). | Validar query params de v2 (`dateFrom/dateTo/storeId?/cashierUserId?/shiftId?/top?`), render con `data-testid` nuevos (`kpi-*`, `mix-*`, `addons-*`, `cash-diff-*`) e intercept determinista de `/api/v1/pos/**`. |
| Endpoints v2 reportes operativos (`kpis`, `mix`, `addons`, `cash-differences`)                    | Backend integration (`PosReportsV2IntegrationTests.cs`) + Frontend API/UI contract tests (Vitest + Playwright).                                                                              | Si cambia contrato/shape de DTOs, actualizar backend integration + modelos FE + specs unit/e2e y documentación en `docs/pos-reports.md`.                                                                          |

## Uso recomendado en PR

1. Identifica la fila del feature/endpoint impactado.
2. Actualiza tests de la columna “qué actualizar”.
3. Si el cambio introduce un nuevo feature/endpoint, agrega una nueva fila a esta matriz.
4. Vincula también cambios de contrato en `docs/compatibility-notes.md` cuando aplique.

| `GET /api/v1/pos/catalog/snapshot` | `backend/tests/CobranzaDigital.Api.Tests/PosCatalogIntegrationTests.cs` valida autorización, payload con `isAvailable` y contrato de ETag/304. | Actualizar al modificar shape del snapshot, reglas de store/timezone o estrategia de cache. |

| Disponibilidad al crear venta (`POST /api/v1/pos/sales`) | `backend/tests/CobranzaDigital.Api.Tests/PosSalesIntegrationTests.cs` valida `409` para `Product/Extra/OptionItem` no disponibles y `400` para IDs inválidos. | Ajustar cuando cambien reglas de disponibilidad o formato de errores `ProblemDetails`. |

| POS snapshot caching (ETag/If-None-Match/304) en frontend | `frontend/src/app/features/pos/services/pos-catalog-snapshot.service.spec.ts` valida guardado de ETag, envío de `If-None-Match`, fallback de `304` y prioridad de `storeId`. | Actualizar al cambiar estrategia de cache cliente, scoping por tienda o firma de `getSnapshot/invalidate`. |

| POS UI disponibilidad (`isAvailable`) | Unit: `frontend/src/app/features/pos/pages/pos-caja.page.spec.ts`. E2E UI-contract: `frontend/e2e/pos.release1.contract.spec.ts` (producto disabled + stale cache con `409`). | Actualizar si cambia copy/UX de “Agotado”, testids, o flujo de refresh de catálogo tras `409`. |

| Admin catálogo toggles de disponibilidad (Product/Extra/OptionItem) | Unit: `frontend/src/app/features/admin/pos-catalog/services/pos-catalog-api.service.spec.ts` valida `isAvailable` en payloads; specs de rutas admin validan rol para `pos/catalog`. | Actualizar al cambiar payloads CRUD, estrategia optimista/rollback o políticas de rol (Admin/Manager). |

## Cobertura específica: stale cache -> refresh (Disponibilidad v1)

| Flujo / Contrato                                          | Tests nuevos/reforzados                                                                                                              | Qué validar al tocarlo                                                                                                                                          |
| --------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Snapshot cacheable (`GET /api/v1/pos/catalog/snapshot`)   | `backend/tests/CobranzaDigital.Api.Tests/PosCatalogIntegrationTests.cs` (`Snapshot_Uses_Etag_And_Changes_When_Availability_Changes`) | Secuencia `200 -> 304` con `If-None-Match` y regreso a `200` con `ETag` distinto tras cambios de disponibilidad/catálogo.                                       |
| `409 ItemUnavailable` en venta (`POST /api/v1/pos/sales`) | `backend/tests/CobranzaDigital.Api.Tests/PosSalesIntegrationTests.cs` (Product/Extra/OptionItem no disponibles)                      | `ProblemDetails.Extensions` debe incluir siempre `itemType`, `itemId`, `itemName` (string vacío cuando no hay nombre).                                          |
| Cache por store en frontend                               | `frontend/src/app/features/pos/services/pos-catalog-snapshot.service.spec.ts`                                                        | La clave de `localStorage` debe estar scoped por store; al cambiar store activo se invalida cache anterior y el siguiente load fuerza snapshot del nuevo store. |
| UX 409 + refresh de catálogo                              | Unit: `frontend/src/app/features/pos/pages/pos-caja.page.spec.ts`; E2E: `frontend/e2e/pos.release1.contract.spec.ts`                 | Mensaje claro de no disponibilidad, CTA “Actualizar catálogo”, invalida cache stale y re-renderiza disponibilidad actualizada.                                  |

| Platform endpoints (`/api/v1/platform/verticals`, `/api/v1/platform/tenants`) | Backend integration: `TenantIsolationIntegrationTests.cs` valida `PlatformOnly` + listado cross-tenant para SuperAdmin. | Mantener cobertura de autorización por rol (`SuperAdmin` vs tenant roles) y contratos CRUD mínimos para vertical/tenant. |
| Tenant isolation POS (`reports`, `catalog snapshot`, `shifts/sales`) | Backend integration: `TenantIsolationIntegrationTests.cs` + suites POS existentes con `TenantId` en seed. | Verificar que `storeId` fuera de tenant regrese `404/403` y que queries nunca mezclen Tenant A/B. |

| SuperAdmin cross-tenant reports (`/api/v1/pos/reports/kpis/summary`) | Backend integration: `backend/tests/CobranzaDigital.Api.Tests/TenantIsolationIntegrationTests.cs` (`SuperAdmin_CanReadGlobalAndTenantScopedKpisReports`). | Validar agregado global (A+B) sin header y scoping por `X-Tenant-Id` para Tenant A/B. |
| Tenant override isolation (`X-Tenant-Id`) | Backend integration: `backend/tests/CobranzaDigital.Api.Tests/TenantIsolationIntegrationTests.cs` (`Manager_CannotOverrideTenantHeader`). | Usuarios tenant no deben poder forzar otro tenant; respuesta esperada `403`. |
| Platform mode tenant-required endpoints (`/pos/catalog/snapshot`, `/pos/admin/*`) | Backend integration: `backend/tests/CobranzaDigital.Api.Tests/TenantIsolationIntegrationTests.cs` (`SuperAdmin_OperationalEndpoints_RequireTenantSelectionInPlatformMode`). | `SuperAdmin` sin tenant efectivo debe recibir `400 tenantId required...`; con `X-Tenant-Id` debe responder `200`. |

| Snapshot template + tenant overrides + store availability | `backend/tests/CobranzaDigital.Api.Tests/PosCatalogIntegrationTests.cs` (`Snapshot_Uses_Etag_And_Changes_When_Availability_Changes`) | Validar exclusión de items disabled, `isAvailable` por store, y ciclo `200 -> 304 -> 200` cuando cambian overrides/disponibilidad. |
| Create sale validation disabled vs unavailable | `backend/tests/CobranzaDigital.Api.Tests/PosSalesIntegrationTests.cs` (`CreateSale_ReturnsConflict_WithStableItemUnavailablePayload_When_Product_NotAvailable`) | `409` con `reason=DisabledByTenant` para override tenant y `reason=UnavailableInStore` para disponibilidad operativa. |

- Platform templates UI: Unit (PlatformCatalogTemplatesApiService, platform tenant interceptor) + E2E UI-contract (routes /app/platform/* con data-testid platform-*)
- Tenant overrides/availability UI: Unit (POS admin catalog services + error propagation) + E2E UI-contract (override-toggle-*, availability-toggle-*)


| POS admin overrides enriquecido (`GET /api/v1/pos/admin/catalog/overrides`) | Backend integration: `backend/tests/CobranzaDigital.Api.Tests/PosCatalogIntegrationTests.cs` (`Catalog_Overrides_Get_Returns_Item_Metadata`). | Mantener cobertura de metadatos opcionales (`itemName`, `itemSku`, `catalogTemplateId`) y compatibilidad de campos existentes (`itemType`, `itemId`, `isEnabled`). |
| POS admin availability GET (`GET /api/v1/pos/admin/catalog/availability`) | Backend integration: `backend/tests/CobranzaDigital.Api.Tests/PosCatalogIntegrationTests.cs` (`Catalog_Availability_Get_Returns_Empty_And_Overrides_By_Store`, `SuperAdmin_Can_Read_CatalogAvailability_With_Tenant_Override_Header`) y `backend/tests/CobranzaDigital.Api.Tests/TenantIsolationIntegrationTests.cs` (`Manager_CannotRead_CatalogAvailability_FromAnotherTenantStore`). | Validar lista vacía sin overrides, listado con items cuando existen, ownership por `storeId`, y acceso de `SuperAdmin` con `X-Tenant-Id`. |

| Inventory snapshot filtering (`ShowOnlyInStock=true`) | Backend integration: `backend/tests/CobranzaDigital.Api.Tests/PosCatalogIntegrationTests.cs` (`Snapshot_Filters_OutOfStock_When_ShowOnlyInStock_Enabled_And_Etag_Changes_After_Adjustment`). | Verificar que productos con `OnHand=0` no aparezcan y que `ETag` cambie al ajustar stock a `>0`. |
| POS sale out-of-stock + concurrency | Backend integration: `backend/tests/CobranzaDigital.Api.Tests/PosSalesIntegrationTests.cs` (`CreateSale_Returns_OutOfStock_When_ShowOnlyInStock_Enabled_And_InsufficientInventory`, `CreateSale_Concurrent_LastUnit_Allows_One_And_Rejects_Other_When_ShowOnlyInStock_Enabled`). | `409 OutOfStock` con `availableQty`; en carrera por último stock, una venta debe pasar y otra fallar. |
| Inventory admin ownership/superadmin override | Backend integration: `backend/tests/CobranzaDigital.Api.Tests/TenantIsolationIntegrationTests.cs` (`Inventory_Upsert_Enforces_TenantOwnership_And_Allows_SuperAdmin_With_TenantHeader`). | Tenant user no debe escribir inventario de otra tienda; SuperAdmin con `X-Tenant-Id` sí puede. |
| Inventory UI (Release C) | Frontend Unit: `frontend/src/app/features/admin/pos-catalog/services/pos-inventory-admin-api.service.spec.ts`, `frontend/src/app/features/admin/pos-catalog/pages/inventory/inventory.page.spec.ts`; E2E UI-contract: `frontend/e2e/pos.inventory.releasec.contract.spec.ts` | Validar URL/query/payload de inventory/settings, flujo de edición de `onHand`, y errores 400 tenant-required en modo plataforma. |
| POS OutOfStock UI-contract (Release C) | Frontend Unit: `frontend/src/app/features/pos/pages/pos-caja.page.spec.ts`; E2E UI-contract: `frontend/e2e/pos.inventory.releasec.contract.spec.ts` | Para `POST /api/v1/pos/sales` con `409 OutOfStock`, la UI debe mostrar `outofstock-alert` + item y `availableQty` cuando exista. |
