<section class="modal" aria-label="Cobro de venta">
  <div class="modal-card">
    <h3>ðŸ’° Cobrar</h3>

    <div class="total-row">
      <span class="total-label">Total a pagar</span>
      <span class="total-amount">${{ total().toFixed(2) }}</span>
    </div>

    <div class="line-items">
      @for (line of paymentLines(); track line.id; let index = $index) {
        <div class="line-item">
          <p class="line-title">Pago #{{ index + 1 }}</p>
          <div class="line-grid">
            <div class="form-group">
              <label [for]="'payment-method-' + line.id">MÃ©todo</label>
              <select
                [id]="'payment-method-' + line.id"
                [attr.data-testid]="'payment-method-' + index"
                [value]="line.method"
                (change)="updateMethod(line.id, $any($event.target).value)"
              >
                @for (method of getAvailableMethods(line.id); track method) {
                  <option [value]="method">{{ method }}</option>
                }
              </select>
            </div>

            <div class="form-group">
              <label [for]="'payment-amount-' + line.id">Monto</label>
              <input
                [id]="'payment-amount-' + line.id"
                [attr.data-testid]="'payment-amount-' + index"
                type="number"
                min="0"
                step="0.01"
                [value]="line.amount"
                (input)="updateAmount(line.id, +$any($event.target).value || 0)"
              />
            </div>

            <div class="form-group">
              <label [for]="'payment-reference-' + line.id">Referencia</label>
              <input
                [id]="'payment-reference-' + line.id"
                [attr.data-testid]="'payment-ref-' + index"
                type="text"
                [value]="line.reference"
                [disabled]="line.method === 'Cash'"
                (input)="updateReference(line.id, $any($event.target).value)"
                placeholder="Voucher / folio"
              />
            </div>
          </div>
          <button type="button" class="btn-link" (click)="removePaymentLine(line.id)">
            Eliminar lÃ­nea
          </button>
        </div>
      }
    </div>

    <button
      type="button"
      class="btn-add"
      data-testid="add-payment"
      (click)="addPaymentLine()"
      [disabled]="getAvailableMethods(null).length === 0"
    >
      + Agregar pago
    </button>

    <div class="cash-feedback">
      <div class="change-row">
        <span>Total pagado</span>
        <strong>${{ paidTotal().toFixed(2) }}</strong>
      </div>
      @if (changeAmount() > 0) {
        <div class="change-row change-positive">
          <span>Cambio</span>
          <strong>${{ changeAmount().toFixed(2) }}</strong>
        </div>
      } @else if (isShort()) {
        <div class="change-row change-negative">
          <span>Falta</span>
          <strong>${{ (total() - paidTotal()).toFixed(2) }}</strong>
        </div>
      }
      @if (isShort()) {
        <p class="error" role="alert">
          {{
            hasCash()
              ? 'Falta dinero para completar el pago.'
              : 'La suma de pagos debe coincidir exactamente con el total.'
          }}
        </p>
      }
      @if (hasInvalidReference()) {
        <p class="error" role="alert">Tarjeta y transferencia requieren referencia.</p>
      }
    </div>

    <div class="modal-actions">
      <button type="button" (click)="cancelAction.emit()">Cancelar</button>
      <button
        type="button"
        data-testid="confirm-payment"
        [disabled]="!canSubmit()"
        (click)="confirmPayment()"
      >
        <span>âœ…</span> Confirmar cobro
      </button>
    </div>
  </div>
</section>
