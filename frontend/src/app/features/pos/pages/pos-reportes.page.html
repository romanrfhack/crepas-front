<div class="reportes-page">
  <header class="page-header">
    <h2>&#128202; Reportes Operativos</h2>
    <p>Resumen operativo POS por rango, cajero y turno</p>
    <div class="header-decoration"></div>
  </header>

  <section class="card filters-card" aria-label="Filtros de reportes">
    <div class="filters-grid">
      <label>
        Desde
        <input
          data-testid="reports-from"
          type="date"
          [ngModel]="from()"
          (ngModelChange)="from.set($event)"
        />
      </label>

      <label>
        Hasta
        <input
          data-testid="reports-to"
          type="date"
          [ngModel]="to()"
          (ngModelChange)="to.set($event)"
        />
      </label>

      <label>
        Cajero
        <select
          data-testid="reports-cashier"
          [ngModel]="selectedCashierUserId()"
          (ngModelChange)="selectedCashierUserId.set($event)"
        >
          <option value="">Todos</option>
          @for (cashierUserId of cashiers(); track cashierUserId) {
            <option [value]="cashierUserId">{{ cashierUserId }}</option>
          }
        </select>
      </label>

      <label>
        Turno
        <select
          data-testid="reports-shift"
          [ngModel]="selectedShiftId()"
          (ngModelChange)="selectedShiftId.set($event)"
        >
          <option value="">Todos</option>
          @for (shift of shifts(); track shift.shiftId) {
            <option [value]="shift.shiftId">{{ shift.shiftId }}</option>
          }
        </select>
      </label>

      <button
        data-testid="reports-refresh"
        type="button"
        (click)="loadReports()"
        [disabled]="loading()"
      >
        @if (loading()) {
          <span class="spinner"></span>
          <span>Actualizando...</span>
        } @else {
          <span>üîÑ Recargar</span>
        }
      </button>
    </div>
  </section>

  <section class="card kpi-section">
    <h3>KPIs</h3>
    @if (getSectionError('kpis')) {
      <p class="error" role="alert" data-testid="report-error-kpis">
        {{ getSectionError('kpis') }}
      </p>
    }
    <div class="kpi-grid">
      <article data-testid="kpi-gross-sales">
        <span>Venta bruta</span>
        <strong>{{ kpis()?.grossSales ?? 0 | currency: 'MXN' : 'symbol' : '1.2-2' }}</strong>
      </article>
      <article data-testid="kpi-tickets">
        <span>Tickets</span>
        <strong>{{ kpis()?.tickets ?? '‚Äî' }}</strong>
      </article>
      <article data-testid="kpi-avg-ticket">
        <span>Ticket promedio</span>
        <strong>{{ kpis()?.avgTicket ?? 0 | currency: 'MXN' : 'symbol' : '1.2-2' }}</strong>
      </article>
      <article data-testid="kpi-avg-items-per-ticket">
        <span>√çtems por ticket</span>
        <strong>{{ kpis()?.avgItemsPerTicket ?? '‚Äî' }}</strong>
      </article>
      <article data-testid="kpi-void-rate">
        <span>Tasa de voids</span>
        <strong>{{ ((kpis()?.voidRate ?? 0) * 100 | number: '1.0-2') + '%' }}</strong>
      </article>
    </div>
  </section>

  <section class="card summary" data-testid="reports-summary">
    <h3>Resumen</h3>
    @if (getSectionError('dailySales')) {
      <p class="error" role="alert" data-testid="report-error-dailySales">
        {{ getSectionError('dailySales') }}
      </p>
    }
    <div class="summary-grid">
      <article>
        <span>Total ventas</span>
        <strong>{{ summary().totalSales | currency: 'MXN' : 'symbol' : '1.2-2' }}</strong>
      </article>
      <article>
        <span>Tickets</span>
        <strong>{{ summary().tickets }}</strong>
      </article>
      <article>
        <span>Ticket promedio</span>
        <strong>{{ summary().avgTicket | currency: 'MXN' : 'symbol' : '1.2-2' }}</strong>
      </article>
    </div>
  </section>

  <section class="card">
    <h3>Mix por categor√≠as</h3>
    @if (getSectionError('mixCategories')) {
      <p class="error" role="alert" data-testid="report-error-mixCategories">
        {{ getSectionError('mixCategories') }}
      </p>
    }
    <div class="table-wrap" data-testid="mix-categories-table">
      <table>
        <thead>
          <tr>
            <th>Categor√≠a</th>
            <th class="numeric">Cantidad</th>
            <th class="numeric">Venta bruta</th>
            <th class="numeric">%</th>
            <th>Barra</th>
          </tr>
        </thead>
        <tbody>
          @for (item of mixCategoriesRows(); track item.categoryId; let i = $index) {
            <tr [attr.data-testid]="'mix-category-row-' + i">
              <td>{{ item.categoryName }}</td>
              <td class="numeric">{{ item.quantity }}</td>
              <td class="numeric">{{ item.grossSales | currency: 'MXN' : 'symbol' : '1.2-2' }}</td>
              <td class="numeric">{{ item.percent | number: '1.0-1' }}%</td>
              <td>
                <div class="mini-bar-track">
                  <div class="mini-bar" [style.width]="getPercentBarWidth(item.percent)"></div>
                </div>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="5">Sin categor√≠as para mostrar.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <h3>Mix por productos (Top 20)</h3>
    @if (getSectionError('mixProducts')) {
      <p class="error" role="alert" data-testid="report-error-mixProducts">
        {{ getSectionError('mixProducts') }}
      </p>
    }
    <div class="table-wrap" data-testid="mix-products-table">
      <table>
        <thead>
          <tr>
            <th>Producto</th>
            <th class="numeric">Cantidad</th>
            <th class="numeric">Venta bruta</th>
            <th class="numeric">%</th>
          </tr>
        </thead>
        <tbody>
          @for (item of mixProductsRows(); track item.productId; let i = $index) {
            <tr [attr.data-testid]="'mix-product-row-' + i">
              <td>{{ item.productName }}</td>
              <td class="numeric">{{ item.quantity }}</td>
              <td class="numeric">{{ item.grossSales | currency: 'MXN' : 'symbol' : '1.2-2' }}</td>
              <td class="numeric">{{ item.percent | number: '1.0-1' }}%</td>
            </tr>
          } @empty {
            <tr>
              <td colspan="4">Sin productos para mostrar.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <h3>Add-ons: Extras</h3>
    @if (getSectionError('addonsExtras')) {
      <p class="error" role="alert" data-testid="report-error-addonsExtras">
        {{ getSectionError('addonsExtras') }}
      </p>
    }
    <div class="table-wrap" data-testid="addons-extras-table">
      <table>
        <thead>
          <tr>
            <th>Extra</th>
            <th class="numeric">Cantidad</th>
            <th class="numeric">Impacto bruto</th>
          </tr>
        </thead>
        <tbody>
          @for (item of addonsExtras(); track item.extraId) {
            <tr>
              <td>{{ item.extraName }}</td>
              <td class="numeric">{{ item.quantity }}</td>
              <td class="numeric">{{ item.grossSales | currency: 'MXN' : 'symbol' : '1.2-2' }}</td>
            </tr>
          } @empty {
            <tr>
              <td colspan="3">Sin extras para mostrar.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <h3>Add-ons: Opciones</h3>
    @if (getSectionError('addonsOptions')) {
      <p class="error" role="alert" data-testid="report-error-addonsOptions">
        {{ getSectionError('addonsOptions') }}
      </p>
    }
    <div class="table-wrap" data-testid="addons-options-table">
      <table>
        <thead>
          <tr>
            <th>Opci√≥n</th>
            <th class="numeric">Uso</th>
            <th class="numeric">Impacto bruto</th>
          </tr>
        </thead>
        <tbody>
          @for (item of addonsOptions(); track item.optionItemId) {
            <tr>
              <td>{{ item.optionItemName }}</td>
              <td class="numeric">{{ item.usageCount }}</td>
              <td class="numeric">{{ item.grossImpact | currency: 'MXN' : 'symbol' : '1.2-2' }}</td>
            </tr>
          } @empty {
            <tr>
              <td colspan="3">Sin opciones para mostrar.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <h3>Control de caja (diferencias)</h3>
    @if (getSectionError('cashDifferences')) {
      <p class="error" role="alert" data-testid="report-error-cashDifferences">
        {{ getSectionError('cashDifferences') }}
      </p>
    }
    <div class="table-wrap" data-testid="cash-diff-table">
      <table>
        <thead>
          <tr>
            <th>Cajero</th>
            <th>Apertura</th>
            <th class="numeric">Esperado</th>
            <th class="numeric">Contado</th>
            <th class="numeric">Diferencia</th>
            <th>Raz√≥n</th>
          </tr>
        </thead>
        <tbody>
          @for (item of cashDifferenceShifts(); track item.shiftId; let i = $index) {
            <tr
              [attr.data-testid]="'cash-diff-row-' + i"
              [class.is-alert]="shouldHighlightCashDifference(item)"
            >
              <td>{{ item.cashierUserName || item.cashierUserId }}</td>
              <td>{{ timezoneService.formatDateTime(item.openedAt) }}</td>
              <td class="numeric">
                {{ item.expectedCash | currency: 'MXN' : 'symbol' : '1.2-2' }}
              </td>
              <td class="numeric">{{ item.countedCash | currency: 'MXN' : 'symbol' : '1.2-2' }}</td>
              <td class="numeric">{{ item.difference | currency: 'MXN' : 'symbol' : '1.2-2' }}</td>
              <td>{{ item.closeReason || '‚Äî' }}</td>
            </tr>
          } @empty {
            <tr>
              <td colspan="6">Sin diferencias de caja para mostrar.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <h3>Ventas por m√©todo de pago</h3>
    @if (getSectionError('payments')) {
      <p class="error" role="alert" data-testid="report-error-payments">
        {{ getSectionError('payments') }}
      </p>
    }
    <div class="table-wrap" data-testid="reports-payments-table">
      <table>
        <thead>
          <tr>
            <th>M√©todo</th>
            <th class="numeric">Transacciones</th>
            <th class="numeric">Monto</th>
            <th class="numeric">%</th>
          </tr>
        </thead>
        <tbody>
          @for (item of paymentRows(); track item.method) {
            <tr>
              <td>{{ item.method }}</td>
              <td class="numeric">{{ item.count }}</td>
              <td class="numeric">{{ item.amount | currency: 'MXN' : 'symbol' : '1.2-2' }}</td>
              <td class="numeric">{{ item.percentage | number: '1.0-1' }}%</td>
            </tr>
          } @empty {
            <tr>
              <td colspan="4">Sin datos para el rango seleccionado.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <h3>Ventas por hora</h3>
    @if (getSectionError('hourly')) {
      <p class="error" role="alert" data-testid="report-error-hourly">
        {{ getSectionError('hourly') }}
      </p>
    }
    <div class="table-wrap" data-testid="reports-hourly-table">
      <table>
        <thead>
          <tr>
            <th>Hora</th>
            <th class="numeric">Tickets</th>
            <th class="numeric">Total</th>
            <th>Barras</th>
          </tr>
        </thead>
        <tbody>
          @for (item of hourlySales(); track item.hour) {
            <tr>
              <td>{{ item.hour }}</td>
              <td class="numeric">{{ item.tickets }}</td>
              <td class="numeric">{{ item.totalSales | currency: 'MXN' : 'symbol' : '1.2-2' }}</td>
              <td>
                <div class="mini-bar-track">
                  <div class="mini-bar" [style.width]="getHourlyBarWidth(item.totalSales)"></div>
                </div>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="4">Sin datos por hora.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <h3>Top productos</h3>
    @if (getSectionError('topProducts')) {
      <p class="error" role="alert" data-testid="report-error-topProducts">
        {{ getSectionError('topProducts') }}
      </p>
    }
    <div class="table-wrap" data-testid="reports-top-products-table">
      <table>
        <thead>
          <tr>
            <th>Producto</th>
            <th class="numeric">Cantidad</th>
            <th class="numeric">Total</th>
          </tr>
        </thead>
        <tbody>
          @for (item of topProducts(); track item.productId) {
            <tr>
              <td>{{ item.productNameSnapshot }}</td>
              <td class="numeric">{{ item.qty }}</td>
              <td class="numeric">{{ item.amount | currency: 'MXN' : 'symbol' : '1.2-2' }}</td>
            </tr>
          } @empty {
            <tr>
              <td colspan="3">Sin productos para mostrar.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <h3>Cancelaciones por motivo</h3>
    @if (getSectionError('voidReasons')) {
      <p class="error" role="alert" data-testid="report-error-voidReasons">
        {{ getSectionError('voidReasons') }}
      </p>
    }
    <div class="table-wrap" data-testid="reports-void-reasons-table">
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Motivo</th>
            <th class="numeric">Conteo</th>
            <th class="numeric">Total cancelado</th>
          </tr>
        </thead>
        <tbody>
          @for (item of voidReasons(); track item.reasonCode + item.reasonText) {
            <tr>
              <td>{{ item.reasonCode }}</td>
              <td>{{ item.reasonText }}</td>
              <td class="numeric">{{ item.count }}</td>
              <td class="numeric">{{ item.amount | currency: 'MXN' : 'symbol' : '1.2-2' }}</td>
            </tr>
          } @empty {
            <tr>
              <td colspan="4">Sin cancelaciones registradas.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </section>
</div>
