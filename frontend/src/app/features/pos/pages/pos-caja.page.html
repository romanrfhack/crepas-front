<section class="pos-caja">
  <header>
    <h1>Caja POS</h1>
    <p>
      CorrelationId: <code>{{ correlationId() }}</code>
    </p>

    @if (openedShiftSummary(); as shiftSummary) {
      <p class="shift-banner" role="status">
        Turno abierto desde {{ shiftSummary.openedAt }} Â· Efectivo inicial: ${{
          shiftSummary.openingCashAmount.toFixed(2)
        }}
      </p>
    } @else {
      <p class="shift-banner shift-banner--warning" role="alert">
        No hay turno abierto para operar.
      </p>
    }

    <div class="toolbar">
      <input
        type="search"
        placeholder="Buscar producto"
        [value]="searchTerm()"
        (input)="searchTerm.set($any($event.target).value)"
      />
      <button type="button" (click)="loadSnapshot(true)">Refrescar catÃ¡logo</button>
      <button type="button" (click)="loadCurrentShift()">Actualizar turno</button>
      <button type="button" (click)="showOpenShiftModal.set(true)" [disabled]="hasOpenShift()">
        Abrir turno
      </button>
      <button type="button" (click)="startCloseShift()" [disabled]="!hasOpenShift()">
        Cerrar turno
      </button>
      <a href="/app/pos/reportes">Ir a reportes</a>
    </div>
  </header>

  @if (errorMessage()) {
    <p class="error" role="alert">{{ errorMessage() }}</p>
  }

  @if (saleSuccess(); as sale) {
    <p class="success" role="status">
      Venta registrada: {{ sale.folio }} Â· Total final: ${{ sale.total.toFixed(2) }}
    </p>
  }

  @if (closeResult(); as closeResult) {
    <p class="success" role="status">
      Cierre registrado Â· Esperado: ${{ closeResult.expectedCashAmount.toFixed(2) }} Â· Contado: ${{
        closeResult.countedCashAmount.toFixed(2)
      }}
      Â· Diferencia: ${{ closeResult.difference.toFixed(2) }}
    </p>
  }

  <div class="layout">
    <app-pos-category-list
      [categories]="categories()"
      [selectedCategoryId]="selectedCategoryId()"
      (selectCategory)="selectedCategoryId.set($event)"
    />

    <div class="product-grid-container">
      <app-pos-product-grid [products]="products()" (addProduct)="onProductSelected($event)" />
    </div>
  </div>

  @if (shiftSales().length > 0) {
    <section class="sales-list" aria-label="Ventas del turno actual">
      <h3>Ventas registradas en esta sesiÃ³n</h3>
      @for (sale of shiftSales(); track sale.saleId) {
        <div class="sale-item">
          <div>
            <strong>{{ sale.folio }}</strong>
            <p>{{ formatDateTime(sale.occurredAtUtc) }}</p>
          </div>
          <div>
            <strong>${{ sale.total.toFixed(2) }}</strong>
            <span [class.void-chip]="sale.status === 'Void'">{{ sale.status === 'Void' ? 'ANULADA' : 'COMPLETADA' }}</span>
          </div>
          @if (sale.status !== 'Void') {
            <button type="button" (click)="openVoidModal(sale)">Cancelar</button>
          }
        </div>
      }
    </section>
  }

  @if (cartItems().length > 0) {
    <button
      type="button"
      class="cart-floating-button"
      [class.has-items]="cartItems().length > 0"
      (click)="toggleCart()"
      aria-label="Carrito de compras"
    >
      ðŸ›’ <span class="cart-floating-badge">{{ cartItems().length }}</span>
    </button>
  }

  @if (cartExpanded() && cartItems().length > 0) {
    <div class="cart-panel">
      <div class="cart-panel-header">
        <span>ðŸ›’ Tu pedido</span>
        <button type="button" class="close-button" (click)="cartExpanded.set(false)">âœ•</button>
      </div>
      <app-pos-cart
        [items]="cartItems()"
        [estimatedTotal]="estimatedTotal()"
        [checkoutDisabled]="!canCheckout()"
        (increase)="increaseQty($event)"
        (decrease)="decreaseQty($event)"
        (remove)="removeFromCart($event)"
        (checkout)="openPaymentModal(); cartExpanded.set(false)"
      />
    </div>
  }

  @if (activeCustomizationProduct(); as product) {
    <div class="customization-wrapper">
      <app-pos-customization-modal
        [product]="product"
        [groups]="customizationGroups()"
        [optionItems]="customizationOptionItems()"
        [extras]="customizationExtras()"
        (cancelAction)="activeCustomizationProduct.set(null)"
        (confirm)="onConfirmCustomization($event)"
      />
    </div>
  }

  @if (showPayment()) {
    <app-pos-payment-modal
      [total]="estimatedTotal()"
      [loading]="loading()"
      (cancelAction)="showPayment.set(false)"
      (submitPayment)="confirmPayment($event)"
    />
  }

  @if (showOpenShiftModal()) {
    <section class="modal" aria-label="Abrir turno">
      <div class="modal-card">
        <h2>Abrir turno</h2>
        <p>Antes de confirmar cobros necesitas abrir tu turno con efectivo inicial.</p>

        <form [formGroup]="openShiftForm" (ngSubmit)="submitOpenShift()">
          <label for="startingCashAmount">Efectivo inicial</label>
          <input
            id="startingCashAmount"
            type="number"
            min="0"
            step="0.01"
            formControlName="startingCashAmount"
          />

          <label for="openNotes">Notas (opcional)</label>
          <textarea id="openNotes" rows="3" formControlName="notes"></textarea>

          <div class="modal-actions">
            <button
              type="button"
              (click)="showOpenShiftModal.set(false)"
              [disabled]="requireOpenShift"
            >
              Cancelar
            </button>
            <button type="submit" [disabled]="openShiftForm.invalid || loading()">
              Confirmar apertura
            </button>
          </div>
        </form>
      </div>
    </section>
  }

  @if (showCloseShiftModal()) {
    <section class="modal" aria-label="Cerrar turno">
      <div class="modal-card modal-card--wide">
        <div class="modal-body">
          <h2>Cierre de turno</h2>
          <p>Captura conteo por denominaciÃ³n para realizar el cierre de caja.</p>

          @if (closePreview(); as preview) {
            <div class="close-summary">
              <p>Apertura: <strong>${{ preview.openingCashAmount.toFixed(2) }}</strong></p>
              <p>Ventas efectivo turno: <strong>${{ preview.salesCashTotal.toFixed(2) }}</strong></p>
              <p># Ventas: <strong>{{ preview.breakdown?.totalSalesCount ?? 0 }}</strong></p>
              <p>Tarjeta: <strong>${{ (preview.breakdown?.cardAmount ?? 0).toFixed(2) }}</strong></p>
              <p>
                Transferencia:
                <strong>${{ (preview.breakdown?.transferAmount ?? 0).toFixed(2) }}</strong>
              </p>
            </div>
          }

          <div class="denomination-grid" [formGroup]="closeShiftForm">
            @for (denomination of denominations; track denomination; let index = $index) {
              <div class="denomination-item">
                <label [for]="'denomination-count-' + index">${{ denomination.toFixed(2) }}</label>
                <input
                  [id]="'denomination-count-' + index"
                  type="number"
                  min="0"
                  step="1"
                  inputmode="numeric"
                  [formControl]="getCountControl(index)"
                  (change)="refreshClosePreviewWithCashCount()"
                />
              </div>
            }
          </div>

          <div class="close-summary">
            <p>Esperado: <strong>${{ closeExpectedAmount().toFixed(2) }}</strong></p>
            <p>Contado: <strong>${{ countedTotal().toFixed(2) }}</strong></p>
            <p>Diferencia: <strong>${{ closeDifference().toFixed(2) }}</strong></p>
          </div>

          <div [formGroup]="closeShiftForm">
            <label for="differenceReason">Motivo de diferencia</label>
            <textarea
              id="differenceReason"
              rows="3"
              formControlName="reason"
              [attr.aria-required]="requiresDifferenceReason()"
              [placeholder]="
                requiresDifferenceReason() ? 'Motivo obligatorio cuando hay diferencia' : 'Opcional'
              "
            ></textarea>

            <label for="closeEvidence">Notas de cierre (opcional)</label>
            <textarea id="closeEvidence" rows="2" formControlName="evidence"></textarea>
          </div>
        </div>

        <div class="modal-actions modal-actions--sticky">
          <button type="button" (click)="showCloseShiftModal.set(false)">Cancelar</button>
          <button type="button" (click)="submitCloseShift()" [disabled]="loading()">
            Confirmar cierre
          </button>
        </div>
      </div>
    </section>
  }

  @if (showVoidModal()) {
    <section class="modal" aria-label="Cancelar venta">
      <div class="modal-card">
        <h2>Cancelar venta</h2>
        @if (selectedSaleForVoid(); as selectedSale) {
          <p>Folio: <strong>{{ selectedSale.folio }}</strong></p>
        }
        <div [formGroup]="voidForm" class="void-form">
          <label for="void-reason-code">Motivo</label>
          <select id="void-reason-code" formControlName="reasonCode">
            <option value="CashierError">CashierError</option>
            <option value="CustomerRequest">CustomerRequest</option>
            <option value="DuplicateSale">DuplicateSale</option>
            <option value="Other">Other</option>
          </select>
          <label for="void-reason-text">DescripciÃ³n (opcional)</label>
          <input id="void-reason-text" type="text" formControlName="reasonText" />

          <label for="void-note">Nota interna (opcional)</label>
          <textarea id="void-note" rows="2" formControlName="note"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" (click)="showVoidModal.set(false)">Cerrar</button>
          <button type="button" [disabled]="loading()" (click)="confirmVoidSale()">Confirmar cancelaciÃ³n</button>
        </div>
      </div>
    </section>
  }
</section>
