<section class="pos-caja">
  <header>
    <h1>Caja POS</h1>
    <p>
      CorrelationId: <code>{{ correlationId() }}</code>
    </p>

    @if (openedShiftSummary(); as shiftSummary) {
      <p class="shift-banner" role="status">
        Turno abierto desde {{ shiftSummary.openedAt }} · Efectivo inicial: ${{
          shiftSummary.openingCashAmount.toFixed(2)
        }}
      </p>
    } @else {
      <p class="shift-banner shift-banner--warning" role="alert">
        No hay turno abierto para operar.
      </p>
    }

    <div class="toolbar">
      <input
        type="search"
        placeholder="Buscar producto"
        [value]="searchTerm()"
        (input)="searchTerm.set($any($event.target).value)"
      />
      <button type="button" (click)="loadSnapshot(true)">Refrescar catálogo</button>
      <button type="button" (click)="loadCurrentShift()">Actualizar turno</button>
      <button type="button" (click)="showOpenShiftModal.set(true)" [disabled]="hasOpenShift()">
        Abrir turno
      </button>
      <button type="button" (click)="startCloseShift()" [disabled]="!hasOpenShift()">
        Cerrar turno
      </button>
      <a href="/app/pos/reportes">Ir a reportes</a>
    </div>
  </header>

  @if (errorMessage()) {
    <p class="error" role="alert">{{ errorMessage() }}</p>
  }

  @if (saleSuccess(); as sale) {
    <p class="success" role="status">
      Venta registrada: {{ sale.folio }} · Total final: ${{ sale.total.toFixed(2) }}
    </p>
  }

  <div class="layout">
    <app-pos-category-list
      [categories]="categories()"
      [selectedCategoryId]="selectedCategoryId()"
      (selectCategory)="selectedCategoryId.set($event)"
    />

    <div class="product-grid-container">
      <app-pos-product-grid [products]="products()" (addProduct)="onProductSelected($event)" />
    </div>

    <app-pos-cart
      [items]="cartItems()"
      [estimatedTotal]="estimatedTotal()"
      [checkoutDisabled]="!canCheckout()"
      (increase)="increaseQty($event)"
      (decrease)="decreaseQty($event)"
      (remove)="removeFromCart($event)"
      (checkout)="openPaymentModal()"
    />
  </div>

  @if (activeCustomizationProduct(); as product) {
    <app-pos-customization-modal
      [product]="product"
      [groups]="customizationGroups()"
      [optionItems]="customizationOptionItems()"
      [extras]="customizationExtras()"
      (cancelAction)="activeCustomizationProduct.set(null)"
      (confirm)="onConfirmCustomization($event)"
    />
  }

  @if (showPayment()) {
    <app-pos-payment-modal
      [total]="estimatedTotal()"
      [loading]="loading()"
      (cancelAction)="showPayment.set(false)"
      (submitPayment)="confirmPayment($event)"
    />
  }

  @if (showOpenShiftModal()) {
    <section class="modal" aria-label="Abrir turno">
      <div class="modal-card">
        <h2>Abrir turno</h2>
        <p>Antes de confirmar cobros necesitas abrir tu turno con efectivo inicial.</p>

        <form [formGroup]="openShiftForm" (ngSubmit)="submitOpenShift()">
          <label for="startingCashAmount">Efectivo inicial</label>
          <input
            id="startingCashAmount"
            type="number"
            min="0"
            step="0.01"
            formControlName="startingCashAmount"
          />

          <label for="openNotes">Notas (opcional)</label>
          <textarea id="openNotes" rows="3" formControlName="notes"></textarea>

          <div class="modal-actions">
            <button
              type="button"
              (click)="showOpenShiftModal.set(false)"
              [disabled]="requireOpenShift"
            >
              Cancelar
            </button>
            <button type="submit" [disabled]="openShiftForm.invalid || loading()">
              Confirmar apertura
            </button>
          </div>
        </form>
      </div>
    </section>
  }

  @if (showCloseShiftModal()) {
    <section class="modal" aria-label="Cerrar turno">
      <div class="modal-card modal-card--wide">
        <h2>Cierre de turno</h2>
        <p>Captura conteo por denominación para realizar el cierre de caja.</p>

        <div class="denomination-grid" [formGroup]="closeShiftForm">
          @for (denomination of denominations; track denomination; let index = $index) {
            <label>
              <span>${{ denomination.toFixed(2) }}</span>
              <input type="number" min="0" [formControl]="getCountControl(index)" />
            </label>
          }
        </div>

        <div class="close-summary">
          <p>
            Esperado: <strong>${{ closeExpectedAmount().toFixed(2) }}</strong>
          </p>
          <p>
            Contado: <strong>${{ countedTotal().toFixed(2) }}</strong>
          </p>
          <p>
            Diferencia: <strong>${{ closeDifference().toFixed(2) }}</strong>
          </p>
        </div>

        <div [formGroup]="closeShiftForm">
          <label for="differenceReason">Motivo de diferencia</label>
          <textarea
            id="differenceReason"
            rows="3"
            formControlName="reason"
            [attr.aria-required]="requiresDifferenceReason()"
            [placeholder]="
              requiresDifferenceReason() ? 'Motivo obligatorio cuando hay diferencia' : 'Opcional'
            "
          ></textarea>

          <label for="closeEvidence">Evidencia (opcional)</label>
          <textarea id="closeEvidence" rows="2" formControlName="evidence"></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" (click)="showCloseShiftModal.set(false)">Cancelar</button>
          <button type="button" (click)="submitCloseShift()" [disabled]="loading()">
            Confirmar cierre
          </button>
        </div>
      </div>
    </section>
  }
</section>
