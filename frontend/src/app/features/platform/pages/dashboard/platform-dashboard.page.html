<div class="platform-dashboard" data-testid="platform-dashboard-page">
  <!-- HEADER con t√≠tulo y bot√≥n de recarga -->
  <header class="dashboard-header">
    <h2>üìä Dashboard de Plataforma</h2>
    <button
      type="button"
      class="btn-primary"
      data-testid="platform-dashboard-refresh"
      (click)="refreshAll()"
    >
      üîÑ Recargar
    </button>
  </header>

  <!-- BADGE DE CONTEXTO ACTIVO (si existe) -->
  @if (hasOperationalContext()) {
    <div data-testid="platform-dashboard-context-badge" class="context-badge">
      {{ operationalContextLabel() }}
    </div>
  }

  <!-- EXECUTIVE SIGNALS -->
  <section class="section-card" data-testid="platform-executive-signals">
    <div class="section-header">
      <span class="section-icon">üìà</span>
      <h3>Executive signals</h3>
    </div>

    @if (executiveSignalsLoading()) {
      <p class="status-message">Cargando se√±ales...</p>
    } @else if (executiveSignalsError()) {
      <div class="error-message" data-testid="platform-executive-signals-error">
        <span class="error-icon">‚ö†Ô∏è</span>
        <span>{{ executiveSignalsError() }}</span>
      </div>
    } @else {
      <div class="kpi-grid">
        <div class="kpi-card" data-testid="platform-executive-signal-growth">
          <span>Crecimiento</span>
          <strong>{{ executiveSignals().salesGrowthRatePercent }}%</strong>
        </div>
        <div class="kpi-card" data-testid="platform-executive-signal-void-rate">
          <span>Void rate</span>
          <strong>{{ executiveSignals().voidRatePercent }}%</strong>
        </div>
        <div class="kpi-card" data-testid="platform-executive-signal-tenants-without-sales">
          <span>Tenants sin ventas</span>
          <strong>{{ executiveSignals().tenantsWithNoSalesInRangeCount }}</strong>
        </div>
        <div class="kpi-card" data-testid="platform-executive-signal-stores-no-admin-store">
          <span>Stores sin AdminStore</span>
          <strong>{{ executiveSignals().storesWithNoAdminStoreCount }}</strong>
        </div>
        <div class="kpi-card" data-testid="platform-executive-signal-tenants-no-template">
          <span>Tenants sin template</span>
          <strong>{{ executiveSignals().tenantsWithNoCatalogTemplateCount }}</strong>
        </div>
        <div class="kpi-card" data-testid="platform-executive-signal-stores-out-of-stock">
          <span>Stores con OOS</span>
          <strong>{{ executiveSignals().storesWithOutOfStockCount }}</strong>
        </div>
        <div class="kpi-card" data-testid="platform-executive-signal-inventory-adjustments">
          <span>Ajustes de inventario</span>
          <strong>{{ executiveSignals().inventoryAdjustmentCountInRange }}</strong>
        </div>
        <div class="kpi-card" data-testid="platform-executive-signal-top-risk-tenant">
          <span>Top riesgo</span>
          <strong>{{ executiveSignals().topRiskTenantName ?? 'N/A' }}</strong>
        </div>
      </div>
    }
  </section>

  <!-- KPIs v1 -->
  <section class="section-card">
    <div class="section-header">
      <span class="section-icon">üìä</span>
      <h3>KPIs</h3>
    </div>

    @if (summaryLoading()) {
      <p class="status-message">Cargando KPIs...</p>
    } @else if (summaryError()) {
      <div class="error-message" role="alert">{{ summaryError() }}</div>
    } @else {
      <div class="kpi-grid">
        <div class="kpi-card" data-testid="platform-kpi-active-tenants">
          <span>Tenants activos</span>
          <strong>{{ summary().activeTenants }}</strong>
        </div>
        <div class="kpi-card" data-testid="platform-kpi-active-stores">
          <span>Tiendas activas</span>
          <strong>{{ summary().activeStores }}</strong>
        </div>
        <div class="kpi-card" data-testid="platform-kpi-total-users">
          <span>Usuarios totales</span>
          <strong>{{ summary().totalUsers }}</strong>
        </div>
        <div class="kpi-card" data-testid="platform-kpi-sales-today">
          <span>Ventas hoy</span>
          <strong>{{ money(summary().salesTodayAmount) }}</strong>
        </div>
        <div class="kpi-card" data-testid="platform-kpi-sales-last7days">
          <span>Ventas 7 d√≠as</span>
          <strong>{{ money(summary().salesLast7DaysAmount) }}</strong>
        </div>
        <div class="kpi-card" data-testid="platform-kpi-open-shifts">
          <span>Turnos abiertos</span>
          <strong>{{ summary().openShiftsCount }}</strong>
        </div>
        <div class="kpi-card" data-testid="platform-kpi-out-of-stock">
          <span>Agotados</span>
          <strong>{{ summary().outOfStockItemsCount }}</strong>
        </div>
        <div class="kpi-card" data-testid="platform-kpi-low-stock">
          <span>Stock bajo</span>
          <strong>{{ summary().lowStockItemsCount }}</strong>
        </div>
      </div>
    }
  </section>

  <!-- SALES TREND -->
  <section class="section-card" data-testid="platform-sales-trend">
    <div class="section-header">
      <span class="section-icon">üìâ</span>
      <h3>Sales trend</h3>
    </div>
    <div class="filters">
      <div class="filter-field">
        <label for="sales-trend-from">Desde</label>
        <input
          id="sales-trend-from"
          type="date"
          class="form-input"
          data-testid="platform-sales-trend-filter-date-from"
          [ngModel]="salesTrendDateFrom()"
          (ngModelChange)="salesTrendDateFrom.set($event)"
        />
      </div>
      <div class="filter-field">
        <label for="sales-trend-to">Hasta</label>
        <input
          id="sales-trend-to"
          type="date"
          class="form-input"
          data-testid="platform-sales-trend-filter-date-to"
          [ngModel]="salesTrendDateTo()"
          (ngModelChange)="salesTrendDateTo.set($event)"
        />
      </div>
      <div class="filter-field">
        <label for="sales-trend-granularity">Granularidad</label>
        <select
          id="sales-trend-granularity"
          class="form-select"
          data-testid="platform-sales-trend-filter-granularity"
          [ngModel]="salesTrendGranularity()"
          (ngModelChange)="salesTrendGranularity.set($event)"
        >
          <option value="day">D√≠a</option>
          <option value="week">Semana</option>
        </select>
      </div>
      <button type="button" class="btn-primary" (click)="loadSalesTrend()">Aplicar</button>
    </div>

    @if (salesTrendLoading()) {
      <p class="status-message">Cargando sales trend...</p>
    } @else if (salesTrendError()) {
      <div class="error-message" data-testid="platform-sales-trend-error">
        {{ salesTrendError() }}
      </div>
    } @else if (!salesTrend().length) {
      <div class="empty-state">
        <span class="empty-icon">üì≠</span>
        <p>Sin resultados para el rango seleccionado.</p>
      </div>
    } @else {
      <div class="table-responsive">
        <table class="modern-table">
          <thead>
            <tr>
              <th>Per√≠odo</th>
              <th class="numeric">Ventas (cantidad)</th>
              <th class="numeric">Monto</th>
            </tr>
          </thead>
          <tbody>
            @for (row of salesTrend(); track row.bucketStartUtc; let idx = $index) {
              <tr [attr.data-testid]="'platform-sales-trend-row-' + idx">
                <td>{{ row.bucketLabel }}</td>
                <td class="numeric">{{ row.salesCount }}</td>
                <td class="numeric">{{ money(row.salesAmount) }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </section>

  <!-- TOP VOID TENANTS -->
  <section class="section-card" data-testid="platform-top-void-tenants">
    <div class="section-header">
      <span class="section-icon">‚ö†Ô∏è</span>
      <h3>Top void tenants</h3>
    </div>
    <div class="filters">
      <div class="filter-field">
        <label for="void-from">Desde</label>
        <input
          id="void-from"
          type="date"
          class="form-input"
          data-testid="platform-top-void-tenants-filter-date-from"
          [ngModel]="topVoidDateFrom()"
          (ngModelChange)="topVoidDateFrom.set($event)"
        />
      </div>
      <div class="filter-field">
        <label for="void-to">Hasta</label>
        <input
          id="void-to"
          type="date"
          class="form-input"
          data-testid="platform-top-void-tenants-filter-date-to"
          [ngModel]="topVoidDateTo()"
          (ngModelChange)="topVoidDateTo.set($event)"
        />
      </div>
      <div class="filter-field">
        <label for="void-top">Top</label>
        <input
          id="void-top"
          type="number"
          min="1"
          max="50"
          class="form-input"
          data-testid="platform-top-void-tenants-filter-top"
          [ngModel]="topVoidTop()"
          (ngModelChange)="topVoidTop.set(+$event || 10)"
        />
      </div>
      <button type="button" class="btn-primary" (click)="loadTopVoidTenants()">Aplicar</button>
    </div>

    @if (topVoidTenantsLoading()) {
      <p class="status-message">Cargando top void tenants...</p>
    } @else if (topVoidTenantsError()) {
      <div class="error-message" data-testid="platform-top-void-tenants-error">
        {{ topVoidTenantsError() }}
      </div>
    } @else if (!topVoidTenants().length) {
      <div class="empty-state">
        <span class="empty-icon">üì≠</span>
        <p>Sin resultados.</p>
      </div>
    } @else {
      <div class="table-responsive">
        <table class="modern-table">
          <thead>
            <tr>
              <th>Tenant</th>
              <th>Vertical</th>
              <th class="numeric">Void count</th>
              <th class="numeric">Total ventas</th>
              <th class="numeric">Void rate</th>
            </tr>
          </thead>
          <tbody>
            @for (row of topVoidTenants(); track row.tenantId) {
              <tr [attr.data-testid]="'platform-top-void-tenant-row-' + row.tenantId">
                <td>{{ row.tenantName }}</td>
                <td>{{ row.verticalName }}</td>
                <td class="numeric">{{ row.voidedSalesCount }}</td>
                <td class="numeric">{{ row.totalSalesCount }}</td>
                <td class="numeric">{{ row.voidRate | percent:'1.2-2' }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </section>

  <!-- STOCKOUT HOTSPOTS -->
  <section class="section-card" data-testid="platform-stockout-hotspots">
    <div class="section-header">
      <span class="section-icon">üî•</span>
      <h3>Stockout hotspots</h3>
    </div>
    <div class="filters">
      <div class="filter-field">
        <label for="hotspot-threshold">Umbral</label>
        <input
          id="hotspot-threshold"
          type="number"
          class="form-input"
          data-testid="platform-stockout-hotspots-filter-threshold"
          [ngModel]="stockoutThreshold()"
          (ngModelChange)="stockoutThreshold.set(+$event || 5)"
        />
      </div>
      <div class="filter-field">
        <label for="hotspot-top">Top</label>
        <input
          id="hotspot-top"
          type="number"
          class="form-input"
          data-testid="platform-stockout-hotspots-filter-top"
          [ngModel]="stockoutTop()"
          (ngModelChange)="stockoutTop.set(+$event || 10)"
        />
      </div>
      <div class="filter-field">
        <label for="hotspot-item-type">Tipo</label>
        <select
          id="hotspot-item-type"
          class="form-select"
          data-testid="platform-stockout-hotspots-filter-item-type"
          [ngModel]="stockoutItemType()"
          (ngModelChange)="stockoutItemType.set($event)"
        >
          <option value="">Todos</option>
          <option value="Product">Product</option>
          <option value="Extra">Extra</option>
          <option value="OptionItem">OptionItem</option>
        </select>
      </div>
      <button type="button" class="btn-primary" (click)="loadStockoutHotspots()">Aplicar</button>
    </div>

    @if (stockoutHotspotsLoading()) {
      <p class="status-message">Cargando hotspots...</p>
    } @else if (stockoutHotspotsError()) {
      <div class="error-message" data-testid="platform-stockout-hotspots-error">
        {{ stockoutHotspotsError() }}
      </div>
    } @else if (!stockoutHotspots().length) {
      <div class="empty-state">
        <span class="empty-icon">üî•</span>
        <p>Sin resultados.</p>
      </div>
    } @else {
      @for (row of stockoutHotspots(); track row.storeId) {
        <div class="drilldown-row" style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 0.5rem;">
          <div [attr.data-testid]="'platform-stockout-hotspot-row-' + row.storeId">
            <strong>{{ row.tenantName }} / {{ row.storeName }}</strong>
            <span style="color: var(--brand-muted); margin-left: 0.5rem;">
              OOS: {{ row.outOfStockItemsCount }} ¬∑ Low: {{ row.lowStockItemsCount }}
            </span>
          </div>
          <button
            type="button"
            class="btn-outline btn-small"
            [attr.data-testid]="'platform-store-stockout-open-' + row.storeId"
            (click)="openStoreStockoutDetails(row.storeId)"
          >
            Ver detalle
          </button>
        </div>
      }
    }
  </section>

  <!-- ACTIVITY FEED -->
  <section class="section-card" data-testid="platform-activity-feed">
    <div class="section-header">
      <span class="section-icon">üìã</span>
      <h3>Activity feed</h3>
    </div>
    <div class="filters">
      <div class="filter-field">
        <label for="activity-take">Cantidad</label>
        <input
          id="activity-take"
          type="number"
          class="form-input"
          data-testid="platform-activity-feed-filter-take"
          [ngModel]="activityFeedTake()"
          (ngModelChange)="activityFeedTake.set(+$event || 20)"
        />
      </div>
      <div class="filter-field">
        <label for="activity-event-type">Evento</label>
        <select
          id="activity-event-type"
          class="form-select"
          data-testid="platform-activity-feed-filter-event-type"
          [ngModel]="activityFeedEventType()"
          (ngModelChange)="activityFeedEventType.set($event)"
        >
          <option value="">Todos</option>
          <option value="SaleCreated">SaleCreated</option>
          <option value="SaleVoided">SaleVoided</option>
          <option value="InventoryAdjusted">InventoryAdjusted</option>
        </select>
      </div>
      <button type="button" class="btn-primary" (click)="loadActivityFeed()">Aplicar</button>
    </div>

    @if (activityFeedLoading()) {
      <p class="status-message">Cargando activity feed...</p>
    } @else if (activityFeedError()) {
      <div class="error-message" data-testid="platform-activity-feed-error">
        {{ activityFeedError() }}
      </div>
    } @else if (!activityFeed().length) {
      <div class="empty-state">
        <span class="empty-icon">üì≠</span>
        <p>Sin actividad reciente.</p>
      </div>
    } @else {
      @for (row of activityFeed(); track row.occurredAtUtc + '-' + row.referenceId; let idx = $index) {
        <div class="drilldown-item" [attr.data-testid]="'platform-activity-feed-row-' + idx">
          <div style="display: flex; justify-content: space-between;">
            <strong>{{ row.eventType }}</strong>
            <span style="color: var(--brand-muted); font-size: 0.85rem;">{{ row.occurredAtUtc | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <p>{{ row.tenantName }} / {{ row.storeName }} - {{ row.title }}</p>
        </div>
      }
    }
  </section>

  <!-- TOP TENANTS POR VENTAS -->
  <section class="section-card" data-testid="platform-top-tenants">
    <div class="section-header">
      <span class="section-icon">üèÜ</span>
      <h3>Top tenants por ventas</h3>
    </div>
    <div class="filters">
      <div class="filter-field">
        <label for="top-tenants-from">Desde</label>
        <input
          id="top-tenants-from"
          type="date"
          class="form-input"
          data-testid="platform-top-tenants-filter-date-from"
          [ngModel]="topTenantsDateFrom()"
          (ngModelChange)="topTenantsDateFrom.set($event)"
        />
      </div>
      <div class="filter-field">
        <label for="top-tenants-to">Hasta</label>
        <input
          id="top-tenants-to"
          type="date"
          class="form-input"
          data-testid="platform-top-tenants-filter-date-to"
          [ngModel]="topTenantsDateTo()"
          (ngModelChange)="topTenantsDateTo.set($event)"
        />
      </div>
      <div class="filter-field">
        <label for="top-tenants-top">Top</label>
        <input
          id="top-tenants-top"
          type="number"
          min="1"
          max="50"
          class="form-input"
          data-testid="platform-top-tenants-filter-top"
          [ngModel]="topTenantsTop()"
          (ngModelChange)="topTenantsTop.set(+$event || 10)"
        />
      </div>
      <button type="button" class="btn-primary" (click)="loadTopTenants()">Aplicar</button>
    </div>

    @if (topTenantsLoading()) {
      <p class="status-message">Cargando top tenants...</p>
    } @else if (topTenantsError()) {
      <div class="error-message" data-testid="platform-top-tenants-error">
        {{ topTenantsError() }}
      </div>
    } @else if (!topTenants().length) {
      <div class="empty-state">
        <span class="empty-icon">üèÜ</span>
        <p>Sin resultados.</p>
      </div>
    } @else {
      <div class="table-responsive">
        <table class="modern-table">
          <thead>
            <tr>
              <th>Tenant</th>
              <th class="numeric">Ventas</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            @for (row of topTenants(); track row.tenantId) {
              <tr [attr.data-testid]="'platform-top-tenants-row-' + row.tenantId">
                <td>{{ row.tenantName }}</td>
                <td class="numeric">{{ money(row.salesAmount) }}</td>
                <td>
                  <button
                    type="button"
                    class="btn-outline btn-small"
                    [attr.data-testid]="'platform-tenant-overview-open-' + row.tenantId"
                    (click)="openTenantOverview(row.tenantId)"
                  >
                    Ver detalle
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </section>

  <!-- ALERTAS -->
  <section class="section-card" data-testid="platform-alerts">
    <div class="section-header">
      <span class="section-icon">üö®</span>
      <h3>Alertas</h3>
    </div>

    @if (alertsLoading()) {
      <p class="status-message">Cargando alertas...</p>
    } @else if (alertsError()) {
      <div class="error-message" data-testid="platform-alerts-error">{{ alertsError() }}</div>
    } @else if (!alerts().length) {
      <div class="empty-state">
        <span class="empty-icon">‚úÖ</span>
        <p>Sin alertas activas.</p>
      </div>
    } @else {
      @for (alert of alerts(); track alert.code) {
        <div [class]="severityClass(alert.severity)" style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 0.5rem;">
          <div [attr.data-testid]="'platform-alert-row-' + alert.code">
            <strong>{{ alert.code }}</strong> ¬∑ {{ alert.count }} ocurrencias
          </div>
          <button
            type="button"
            class="btn-outline btn-small"
            [attr.data-testid]="'platform-alert-drilldown-open-' + alert.code"
            (click)="openAlertDrilldown(alert.code)"
          >
            Ver detalles
          </button>
        </div>
      }
    }
  </section>

  <!-- RECENT INVENTORY ADJUSTMENTS -->
  <section class="section-card" data-testid="platform-recent-adjustments">
    <div class="section-header">
      <span class="section-icon">üì¶</span>
      <h3>Ajustes de inventario recientes</h3>
    </div>
    <div class="filters">
      <div class="filter-field">
        <label for="recent-take">Cantidad</label>
        <input
          id="recent-take"
          type="number"
          class="form-input"
          [ngModel]="recentTake()"
          (ngModelChange)="recentTake.set(+$event || 20)"
        />
      </div>
      <div class="filter-field">
        <label for="recent-reason">Raz√≥n</label>
        <input
          id="recent-reason"
          type="text"
          placeholder="filtro"
          class="form-input"
          [ngModel]="recentReason()"
          (ngModelChange)="recentReason.set($event)"
        />
      </div>
      <div class="filter-field">
        <label for="recent-tenant">Tenant ID</label>
        <input
          id="recent-tenant"
          type="text"
          class="form-input"
          [ngModel]="recentTenantId()"
          (ngModelChange)="recentTenantId.set($event)"
        />
      </div>
      <div class="filter-field">
        <label for="recent-store">Store ID</label>
        <input
          id="recent-store"
          type="text"
          class="form-input"
          [ngModel]="recentStoreId()"
          (ngModelChange)="recentStoreId.set($event)"
        />
      </div>
      <button type="button" class="btn-primary" (click)="loadRecentAdjustments()">Aplicar</button>
    </div>

    @if (recentAdjustmentsLoading()) {
      <p class="status-message">Cargando ajustes...</p>
    } @else if (recentAdjustmentsError()) {
      <div class="error-message" data-testid="platform-recent-adjustments-error">
        {{ recentAdjustmentsError() }}
      </div>
    } @else if (!recentAdjustments().length) {
      <div class="empty-state">
        <span class="empty-icon">üì¶</span>
        <p>Sin ajustes recientes.</p>
      </div>
    } @else {
      @for (row of recentAdjustments(); track row.adjustmentId) {
        <div class="drilldown-item" [attr.data-testid]="'platform-recent-adjustment-row-' + row.adjustmentId">
          <div style="display: flex; justify-content: space-between;">
            <strong>{{ row.itemName }}</strong>
            <span style="color: var(--brand-muted);">({{ row.qtyDelta }})</span>
          </div>
          <p style="font-size: 0.85rem;">{{ row.tenantName }} / {{ row.storeName }} ¬∑ {{ row.reason }}</p>
        </div>
      }
    }
  </section>

  <!-- OUT OF STOCK -->
  <section class="section-card" data-testid="platform-out-of-stock">
    <div class="section-header">
      <span class="section-icon">‚ö†Ô∏è</span>
      <h3>Agotados</h3>
    </div>
    <div class="filters">
      <div class="filter-field">
        <label for="out-tenant">Tenant ID</label>
        <input
          id="out-tenant"
          type="text"
          class="form-input"
          [ngModel]="outTenantId()"
          (ngModelChange)="outTenantId.set($event)"
        />
      </div>
      <div class="filter-field">
        <label for="out-store">Store ID</label>
        <input
          id="out-store"
          type="text"
          class="form-input"
          [ngModel]="outStoreId()"
          (ngModelChange)="outStoreId.set($event)"
        />
      </div>
      <div class="filter-field">
        <label for="out-item-type">Tipo</label>
        <select
          id="out-item-type"
          class="form-select"
          [ngModel]="outItemType()"
          (ngModelChange)="outItemType.set($event)"
        >
          <option value="">Todos</option>
          <option value="Product">Product</option>
          <option value="Extra">Extra</option>
          <option value="OptionItem">OptionItem</option>
        </select>
      </div>
      <div class="filter-field">
        <label for="out-search">Buscar</label>
        <input
          id="out-search"
          type="text"
          class="form-input"
          placeholder="nombre"
          [ngModel]="outSearch()"
          (ngModelChange)="outSearch.set($event)"
        />
      </div>
      <div class="filter-field">
        <label for="out-top">Top</label>
        <input
          id="out-top"
          type="number"
          class="form-input"
          [ngModel]="outTop()"
          (ngModelChange)="outTop.set(+$event || 50)"
        />
      </div>
      <button type="button" class="btn-primary" (click)="loadOutOfStock()">Aplicar</button>
    </div>

    @if (outOfStockLoading()) {
      <p class="status-message">Cargando agotados...</p>
    } @else if (outOfStockError()) {
      <div class="error-message" data-testid="platform-out-of-stock-error">
        {{ outOfStockError() }}
      </div>
    } @else if (!outOfStock().length) {
      <div class="empty-state">
        <span class="empty-icon">‚úÖ</span>
        <p>Sin elementos agotados.</p>
      </div>
    } @else {
      @for (row of outOfStock(); track row.itemId + '-' + row.storeId) {
        <div class="drilldown-item" [attr.data-testid]="'platform-out-of-stock-row-' + row.itemType + '-' + row.itemId + '-' + row.storeId">
          <div style="display: flex; justify-content: space-between;">
            <strong>{{ row.itemName }}</strong>
            <span style="color: var(--brand-muted);">{{ row.storeName }}</span>
          </div>
          <p style="font-size: 0.85rem;">{{ row.tenantName }} ¬∑ SKU: {{ row.itemSku }}</p>
        </div>
      }
    }
  </section>
</div>

<!-- DRILLDOWN OVERLAY -->
@if (activeDrilldownPanel() !== 'none') {
  <section class="drilldown-overlay">
    <aside class="drilldown-panel">
      <!-- ALERT DRILLDOWN -->
      @if (activeDrilldownPanel() === 'alert') {
        <div data-testid="platform-alert-drilldown">
          <header class="drilldown-header">
            <h3 data-testid="platform-alert-drilldown-title">Alerta {{ alertDrilldownCode() }}</h3>
            <button
              type="button"
              data-testid="platform-alert-drilldown-close"
              (click)="closeDrilldown()"
            >
              ‚úï Cerrar
            </button>
          </header>

          @if (alertDrilldownLoading()) {
            <p class="status-message">Cargando detalles...</p>
          } @else if (alertDrilldownError()) {
            <div class="error-message" data-testid="platform-alert-drilldown-error">
              {{ alertDrilldownError() }}
            </div>
          } @else if (!alertDrilldownItems().length) {
            <div class="empty-state" data-testid="platform-alert-drilldown-empty">
              <span class="empty-icon">üì≠</span>
              <p>Sin registros para esta alerta.</p>
            </div>
          } @else {
            @for (item of alertDrilldownItems(); track item.description + '-' + item.userId; let idx = $index) {
              <article
                [attr.data-testid]="'platform-alert-drilldown-row-' + idx"
                class="drilldown-item"
              >
                <p><strong>Tenant:</strong> {{ item.tenantName ?? 'N/A' }}</p>
                @if (item.storeName) {
                  <p><strong>Store:</strong> {{ item.storeName }}</p>
                }
                <p><strong>Descripci√≥n:</strong> {{ item.description }}</p>
                <p><strong>Raz√≥n:</strong> {{ item.reason ?? 'N/A' }}</p>
                @if (hasAlertAction(alertDrilldownCode())) {
                  @if (alertActionDisabled(alertDrilldownCode(), item)) {
                    <button
                      type="button"
                      class="btn-outline"
                      disabled
                      [attr.data-testid]="
                        'platform-alert-drilldown-action-disabled-' +
                        alertDrilldownCode() +
                        '-' +
                        idx
                      "
                    >
                      {{ alertActionLabel(alertDrilldownCode()) }}
                    </button>
                  } @else {
                    <button
                      type="button"
                      class="btn-primary"
                      [attr.data-testid]="
                        alertDrilldownCode() === 'STORE_WITHOUT_ADMINSTORE'
                          ? 'platform-alert-drilldown-action-create-adminstore-' + idx
                          : 'platform-alert-drilldown-action-' + alertDrilldownCode() + '-' + idx
                      "
                      (click)="navigateFromAlert(alertDrilldownCode(), item)"
                    >
                      {{ alertActionLabel(alertDrilldownCode()) }}
                    </button>
                  }
                }
              </article>
            }
          }
        </div>
      }

      <!-- TENANT OVERVIEW -->
      @if (activeDrilldownPanel() === 'tenant') {
        <div data-testid="platform-tenant-overview">
          <header class="drilldown-header">
            <h3 data-testid="platform-tenant-overview-title">Tenant overview</h3>
            <button
              type="button"
              data-testid="platform-tenant-overview-close"
              (click)="closeDrilldown()"
            >
              ‚úï Cerrar
            </button>
          </header>

          @if (tenantOverviewLoading()) {
            <p class="status-message">Cargando overview...</p>
          } @else if (tenantOverviewError()) {
            <div class="error-message" data-testid="platform-tenant-overview-error">
              {{ tenantOverviewError() }}
            </div>
          } @else if (tenantOverview()) {
            <div class="overview-grid">
              <div class="kpi-card" data-testid="platform-tenant-overview-metric-tenantName">
                <span>Tenant</span>
                <strong>{{ tenantOverview()?.tenantName }}</strong>
              </div>
              <div class="kpi-card" data-testid="platform-tenant-overview-metric-vertical">
                <span>Vertical</span>
                <strong>{{ tenantOverview()?.verticalName ?? 'N/A' }}</strong>
              </div>
              <div class="kpi-card" data-testid="platform-tenant-overview-metric-storeCount">
                <span>Tiendas</span>
                <strong>{{ tenantOverview()?.storeCount }} (activas: {{ tenantOverview()?.activeStoreCount }})</strong>
              </div>
              <div class="kpi-card" data-testid="platform-tenant-overview-metric-totalUsers">
                <span>Usuarios</span>
                <strong>{{ tenantOverview()?.totalUsers }}</strong>
              </div>
              <div class="kpi-card" data-testid="platform-tenant-overview-metric-usersWithoutStoreAssignmentCount">
                <span>Usuarios sin tienda</span>
                <strong>{{ tenantOverview()?.usersWithoutStoreAssignmentCount }}</strong>
              </div>
              <div class="kpi-card" data-testid="platform-tenant-overview-metric-salesInRange">
                <span>Ventas en rango</span>
                <strong>{{ tenantOverview()?.salesInRangeCount }} ¬∑ {{ money(tenantOverview()?.salesInRangeAmount ?? 0) }}</strong>
              </div>
              <div class="kpi-card" data-testid="platform-tenant-overview-metric-voidedSalesCount">
                <span>Ventas void</span>
                <strong>{{ tenantOverview()?.voidedSalesCount }}</strong>
              </div>
              <div class="kpi-card" data-testid="platform-tenant-overview-metric-stockCounts">
                <span>Agotados / Stock bajo</span>
                <strong>{{ tenantOverview()?.outOfStockItemsCount }} / {{ tenantOverview()?.lowStockItemsCount }}</strong>
              </div>
              <div class="kpi-card" data-testid="platform-tenant-overview-metric-lastInventoryAdjustmentAtUtc">
                <span>√öltimo ajuste</span>
                <strong>{{ (tenantOverview()?.lastInventoryAdjustmentAtUtc | date:'dd/MM/yyyy HH:mm') ?? 'N/A' }}</strong>
              </div>
              <div class="kpi-card" data-testid="platform-tenant-overview-metric-hasCatalogTemplate">
                <span>Tiene template</span>
                <strong>{{ tenantOverview()?.hasCatalogTemplate ? 'S√≠' : 'No' }}</strong>
              </div>
              <div class="kpi-card" data-testid="platform-tenant-overview-metric-storesWithoutAdminStoreCount">
                <span>Tiendas sin AdminStore</span>
                <strong>{{ tenantOverview()?.storesWithoutAdminStoreCount }}</strong>
              </div>
            </div>
            <div class="drilldown-actions">
              <button
                type="button"
                class="btn-primary"
                data-testid="platform-tenant-overview-action-create-tenantadmin"
                (click)="navigateToTenantUsers()"
              >
                Crear TenantAdmin
              </button>
            </div>
          }
        </div>
      }

      <!-- STORE STOCKOUT DETAILS -->
      @if (activeDrilldownPanel() === 'stockout') {
        <div data-testid="platform-store-stockout-details">
          <header class="drilldown-header">
            <h3 data-testid="platform-store-stockout-title">Detalle de stockout</h3>
            <button
              type="button"
              data-testid="platform-store-stockout-close"
              (click)="closeDrilldown()"
            >
              ‚úï Cerrar
            </button>
          </header>

          <div class="filters" style="margin-bottom: 1rem;">
            <div class="filter-field">
              <label for="stockout-item-type">Tipo</label>
              <select
                id="stockout-item-type"
                class="form-select"
                data-testid="platform-store-stockout-filter-item-type"
                [ngModel]="stockoutDetailsItemType()"
                (ngModelChange)="stockoutDetailsItemType.set($event)"
              >
                <option value="">Todos</option>
                <option value="Product">Product</option>
                <option value="Extra">Extra</option>
                <option value="OptionItem">OptionItem</option>
              </select>
            </div>
            <div class="filter-field">
              <label for="stockout-search">Buscar</label>
              <input
                id="stockout-search"
                type="text"
                class="form-input"
                data-testid="platform-store-stockout-filter-search"
                [ngModel]="stockoutDetailsSearch()"
                (ngModelChange)="stockoutDetailsSearch.set($event)"
              />
            </div>
            <div class="filter-field">
              <label for="stockout-threshold">Umbral</label>
              <input
                id="stockout-threshold"
                type="number"
                class="form-input"
                data-testid="platform-store-stockout-filter-threshold"
                [ngModel]="stockoutDetailsThreshold()"
                (ngModelChange)="stockoutDetailsThreshold.set(+$event || 5)"
              />
            </div>
            <div class="filter-field">
              <label for="stockout-mode">Modo</label>
              <select
                id="stockout-mode"
                class="form-select"
                data-testid="platform-store-stockout-filter-mode"
                [ngModel]="stockoutDetailsMode()"
                (ngModelChange)="stockoutDetailsMode.set($event)"
              >
                <option value="out-of-stock">Out of stock</option>
                <option value="low-stock">Low stock</option>
                <option value="all">Todos</option>
              </select>
            </div>
            <button type="button" class="btn-primary" (click)="applyStockoutDetailFilters()">Aplicar</button>
          </div>

          @if (stockoutDetailsLoading()) {
            <p class="status-message">Cargando detalles...</p>
          } @else if (stockoutDetailsError()) {
            <div class="error-message" data-testid="platform-store-stockout-error">
              {{ stockoutDetailsError() }}
            </div>
          } @else if (!stockoutDetails()?.items?.length) {
            <div class="empty-state" data-testid="platform-store-stockout-empty">
              <span class="empty-icon">üì≠</span>
              <p>Sin √≠tems para los filtros seleccionados.</p>
            </div>
          } @else {
            <div class="drilldown-actions">
              <button
                type="button"
                class="btn-primary"
                data-testid="platform-store-stockout-action-create-user"
                (click)="navigateToStoreUsers()"
              >
                Crear usuario en sucursal
              </button>
            </div>
            @for (item of stockoutDetails()?.items; track item.itemId; let idx = $index) {
              <article
                [attr.data-testid]="'platform-store-stockout-row-' + idx"
                class="drilldown-item"
              >
                <div style="display: flex; justify-content: space-between;">
                  <strong>{{ item.itemName }}</strong>
                  <span style="color: var(--brand-muted);">{{ item.itemType }}</span>
                </div>
                <p>Stock: {{ item.stockOnHandQty }} ¬∑ SKU: {{ item.itemSku ?? 'N/A' }}</p>
                <p>Raz√≥n: {{ item.availabilityReason }}</p>
                <p style="font-size: 0.85rem;">√öltimo ajuste: {{ (item.lastAdjustmentAtUtc | date:'dd/MM/yyyy HH:mm') ?? 'N/A' }}</p>
              </article>
            }
          }
        </div>
      }
    </aside>
  </section>
}